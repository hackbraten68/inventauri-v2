---
import '../styles/global.css';
import { SessionGuard } from '../components/auth/SessionGuard';
import { SidebarSettings } from '../components/layout/SidebarSettings';

interface NavItem {
  href: string;
  label: string;
  description: string;
}

const themePreferenceCookie = Astro.cookies.get('inventauri-theme')?.value;
const initialThemePreference = ['light', 'dark', 'catppuccin'].includes(themePreferenceCookie ?? '')
  ? themePreferenceCookie
  : 'dark';
const initialThemeClass = initialThemePreference === 'catppuccin'
  ? 'catppuccin dark'
  : initialThemePreference === 'dark'
    ? 'dark'
    : '';

const {
  title = 'Inventauri',
  description = 'Lightweight inventory for micro-shops',
  navItems = [
    { href: '/dashboard', label: 'Dashboard', description: 'Kennzahlen & Trends' },
    { href: '/inventory', label: 'Gesamt Inventar', description: 'Artikelübersicht & Lagerbestände' },
    { href: '/pos', label: 'POS / Warehouse', description: 'Schnelle Buchungen & Warenausgang' },
    { href: '/items', label: 'Artikelverwaltung', description: 'Produkte, Varianten & Lieferanten' },
    { href: '/items/new', label: 'Artikel anlegen', description: 'Neue Produkte erfassen' }
  ] satisfies NavItem[],
  className = ''
} = Astro.props;
---

<html lang="de" class={`h-full ${initialThemeClass}`} data-theme-preference={initialThemePreference} data-theme={initialThemePreference === 'catppuccin' ? 'catppuccin' : initialThemePreference}>
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
    <title>{title}</title>  
    <script>
      {`
        (function() {
          try {
            const storageKey = 'inventauri-theme';
            const stored = localStorage.getItem(storageKey);
            const datasetPreference = document.documentElement.dataset.themePreference;
            const isValidPreference = (value) => ['light', 'dark', 'catppuccin'].includes(value);
            const preference = isValidPreference(stored)
              ? stored
              : isValidPreference(datasetPreference)
                ? datasetPreference
                : 'dark';
            const theme = preference;

            document.documentElement.classList.remove('catppuccin');
            if (preference === 'catppuccin') {
              document.documentElement.classList.add('catppuccin');
              document.documentElement.classList.add('dark');
            } else {
              document.documentElement.classList.remove('catppuccin');
              document.documentElement.classList.toggle('dark', preference === 'dark');
            }
            document.documentElement.dataset.theme = preference === 'catppuccin' ? 'catppuccin' : preference;
            document.documentElement.dataset.themePreference = preference;
          } catch (err) {
            console.warn('Failed to apply stored theme preference.', err);
          }
        })();
      `}
    </script>
  </head>
  <body class={`min-h-full bg-background text-foreground` + (className ? ` ${className}` : '')}>
    <SessionGuard client:load />
    <div class="flex min-h-screen flex-col md:flex-row">
      <aside class="flex flex-col border-b border-r border-border bg-card/60 backdrop-blur supports-[backdrop-filter]:bg-card/70 md:sticky md:top-0 md:h-screen md:w-64">
        <div class="flex items-center justify-between border-b border-border px-6 py-4">
          <div>
            <p class="text-sm font-semibold text-muted-foreground">Inventauri</p>
            <p class="text-lg font-bold text-foreground">Control Center</p>
          </div>
          <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-primary/10 text-primary">IA</span>
        </div>
        <nav class="flex-1 space-y-1 overflow-y-auto px-3 py-4">
          {navItems.map((item: NavItem) => (
            <a
              href={item.href}
              class="group block rounded-lg px-3 py-2 transition-colors hover:bg-accent hover:text-accent-foreground"
            >
              <p class="text-sm font-medium">{item.label}</p>
              <p class="text-xs text-muted-foreground group-hover:text-accent-foreground/80">
                {item.description}
              </p>
            </a>
          ))}
        </nav>
        <div class="border-t border-border px-3 py-4">
          <SidebarSettings client:load />
        </div>
      </aside>
      <main class="flex-1 bg-background">
        <header class="flex flex-col gap-4 border-b border-border bg-card/40 px-6 py-6 backdrop-blur supports-[backdrop-filter]:bg-card/60 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h1 class="text-2xl font-semibold tracking-tight text-foreground">{title}</h1>
            <p class="text-sm text-muted-foreground">{description}</p>
          </div>
          <div class="flex items-center gap-3">
            <div class="hidden flex-col text-right text-sm text-muted-foreground sm:flex">
              <span class="font-medium text-foreground">Demo Benutzer</span>
              <span>demo@inventauri.app</span>
            </div>
            <div class="h-10 w-10 rounded-full bg-secondary" />
          </div>
        </header>
        <div class="container mx-auto flex w-full flex-1 flex-col gap-6 px-4 py-6">
          <slot />
        </div>
      </main>
    </div>
  </body>
</html>
